---
output:
  knitrBootstrap::bootstrap_document:
    title: "Follow-up analysis on effect sizes"
    theme: default
---

More on divergence effect sizes
================================

```{r run_date, results='asis', echo=FALSE}
email = "<a href='mailto:joyce.hsiao1@gmail.com'>Joyce Hsiao</a>"
last_update = format(Sys.time(), "(<time>%Y-%m-%d</time>)")
cat(paste(email, last_update))
```


```{r knitr_settings, include=FALSE, echo=FALSE}
library(knitr)
library(Biobase)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(fig.width = 800/96, fig.height = 800/96, dpi = 96,
              message = FALSE, warning = FALSE, eval = FALSE, 
              echo = TRUE,
              bootstrap.panel = FALSE, bootstrap.show.code = FALSE)
#opts_chunk$set(dpi=96, message = FALSE, warning = FALSE, eval = TRUE, echo = FALSE )
```


Goal
=====

> Of all the 3,188 genes included in the analysis, we investigate divergence at the protein level relative to the RNA level in genes that 1) are considered to be **attenuated** at the protein level relative to the RNA level - (sig. different between RNA and protein divergence) *AND* ( (the absolute value of protein divergence is smaller than the absolute value of RNA divergence) *OR* (protein divergence is in the opposite direction of RNA divergence) ); 2) are considered to be **enhanced** at the protein level relative to the RNA level - (sig. different between RNA and protein divergence) *AND* ( (the absolute value of protein divergence is greater than the absolute value of RNA divergence) *AND* (protein divergence is in the opposite direction of RNA divergence) ); 3) are neither enhanced nor attenuated at the protein level relative to the RNA level. 

> We apply the above definition of enhanced and attenuated divergence to also the discussion of divergence at the translation level relative to the RNA level. 




**********************************

Results
========

## Part I

### RNA > Protein

```{r}
## Set working directories 
dir <- "~/Dropbox/riboRNAShared"
rdadir <- file.path(dir,"rdas")
codedir <- file.path(dir,"codes") 


## Use broman package for colors
require(broman)
crayon <- brocolors("crayons")


source(file.path( codedir, "prepareDivergencePlots.R") )
source(file.path( codedir, "plotDivergenceScatter.r") )

## Extract measurements for easy plotting
xy.rnapro = data.frame(rna=dmat_unnormed$rna,
                       pro=dmat_unnormed$pro)
xy.riborna = data.frame(rna=dmat_unnormed$rna,
                        ribo=dmat_unnormed$ribo)
xy.ribopro = data.frame(ribo=dmat_unnormed$ribo,
                        pro=dmat_unnormed$pro)

## Index class of genes 
ii_riboGTrna = res.riborna$int.qval<.01 & (abs(xy.riborna$ribo) > abs(xy.riborna$rna))
ii_rnaGTribo = res.riborna$int.qval<.01 & (abs(xy.riborna$ribo) < abs(xy.riborna$rna))

# ## Previous definition
# ii_rnaGTpro = res.rnapro$int.qval<.01 & ( (abs(xy.rnapro$rna) > abs(xy.rnapro$pro)) | (xy.rnapro$rna * xy.rnapro$pro < 0) )
# ii_proGTrna = res.rnapro$int.qval<.01 & ( (abs(xy.rnapro$pro) > abs(xy.rnapro$rna)) & (xy.rnapro$rna * xy.rnapro$pro > 0 ) )
# ii_proNULLrna = (!(ii_rnaGTpro|ii_proGTrna))

## Definition of enhanced, attenuated, and null divergence in this document

# Attenuated divergence
ii_rnaGTpro = res.rnapro$int.qval<.01 & ( (abs(xy.rnapro$rna) > abs(xy.rnapro$pro)) | (xy.rnapro$rna * xy.rnapro$pro < 0) )

# Enhanced divegence
ii_proGTrna = res.rnapro$int.qval<.01 & ( (abs(xy.rnapro$pro) > abs(xy.rnapro$rna)) & (xy.rnapro$rna * xy.rnapro$pro > 0 ) )

# Null divergence
ii_proNULLrna = (!(ii_rnaGTpro|ii_proGTrna))
```



> Among the genes that are attenuated at the protein level compared to the RNA level (RNA > protein), we are interested in the number of genes with attenuated translation as defined by the following: 1) sig. diff between Ribo and RNA, AND 2) when direction of species effect at Ribo is flipped in comparison to RNA regardless of the magnitude of the effect size *OR* when there is less divergence at the Ribo level and at the RNA level.

> Significant enrichment (p-value < 1e-15). Genes that are attenuated at the protein level are more likely to be attenuated at the translation level than to be enhanced at the translation level. The test is performend against the null hypothesis of prop. of attenuated genes under RNA ~ Protein (285/2877 = .0991).  


```{r}
ii_subset1 <- dmat_unnormed$rna*dmat_unnormed$ribo < 0
ii_subset2 <- abs(dmat_unnormed$ribo) < abs(dmat_unnormed$rna)
ii_sub <- ii_subset1 | ii_subset2
ii_attenuated_translation <- (res.riborna$int.qval<.01)*ii_sub

## RNA > Protein 
index_list <- list(ii_proNULLrna, ii_rnaGTpro, ii_proGTrna)
boxplot(abs(dmat_unnormed$rna[ii_rnaGTpro]),
        abs(dmat_unnormed$ribo[ii_rnaGTpro]),
        abs(dmat_unnormed$pro[ii_rnaGTpro]), 
        axes = F, ylim = c(0, 10))
axis(1, at = c(1,2,3), labels = c("RNA", "Ribo", "Protein"), 
     col = "white")
axis(2)
points_cols <- c("Scarlet", "Sunglow", "Shamrock")
points(rep(1, sum(ii_rnaGTpro)), abs(dmat_unnormed$rna[ii_rnaGTpro]), 
       pch = 19, cex = .5, 
       col = crayon[points_cols[1]] )
points(rep(2, sum(ii_rnaGTpro)), abs(dmat_unnormed$ribo[ii_rnaGTpro]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[2]] )
points(rep(3, sum(ii_rnaGTpro)), abs(dmat_unnormed$pro[ii_rnaGTpro]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[3]] )
text(2.2, 9, adj = 0,
     label = paste("RNA > Protein", sum(ii_rnaGTpro), 
                   "genes" ) )
text(2.2, 8, adj = 0,
     label = paste("RNA vs. Ribo sig. diff.", 
      sum(ii_rnaGTpro*(res.riborna$int.qval<.01)), 
      "genes; \n",
      round(100*sum(ii_rnaGTpro*(res.riborna$int.qval<.01))/sum(ii_rnaGTpro), 2),"%") )
text(2.2, 7, adj = 0,
     label = paste("Attenuated at translation", 
      sum(ii_rnaGTpro*ii_attenuated_translation), "genes; \n",
      round(100*sum(ii_rnaGTpro*ii_attenuated_translation)/sum(ii_rnaGTpro), 2),"%") )
title(main = paste("RNA > Protein",sum(ii_rnaGTpro),
                   "genes (Attenuated divergence)"),
      ylab = "absolute divergence (human-chimpanzee fold change)")

binom.test( sum(ii_rnaGTpro*ii_attenuated_translation),
           sum(ii_rnaGTpro), p = .099)
```





### RNA < Protein

> Among the genes that are enhanced at the protein level relative to the RNA level (RNA < Protein), we are interested in the number of genes that are attenuated at the translation level relative to the RNA level: 1) sig. diff between Ribo and RNA, AND 2) when direction of species effect at Ribo is consistent with RNA, or when there is greater divergence effect size (absolute value of divergence) at the Ribo level than at the RNA level.

> Significant enrichment (p-value < .0005). Genes that are enhanced at the protein level are more likely to be enhanced at the translation level than to be attenuated at the translation level. The test is performend against the null hypothesis of prop. of enhanced genes under RNA ~ Protein (90/2877 = .0313).  

```{r}
ii_subset1 <- dmat_unnormed$rna * dmat_unnormed$ribo > 0
ii_subset2 <- abs(dmat_unnormed$ribo) > abs(dmat_unnormed$rna)
ii_sub <- ii_subset1 & ii_subset2
ii_sam <- ii_proGTrna * (res.riborna$int.qval<.01) * ii_subset1
ii_reinforced_translation <- (res.riborna$int.qval<.01)*ii_sub

## RNA < Protein 
index_list <- list(ii_proNULLrna, ii_rnaGTpro, ii_proGTrna)
boxplot(abs(dmat_unnormed$rna[ii_proGTrna]),
        abs(dmat_unnormed$ribo[ii_proGTrna]),
        abs(dmat_unnormed$pro[ii_proGTrna]), 
        axes = F, ylim = c(0, 10))
axis(1, at = c(1,2,3), labels = c("RNA", "Ribo", "Protein"), 
     col = "white")
axis(2)
points_cols <- c("Scarlet", "Sunglow", "Shamrock")
points(rep(1, sum(ii_proGTrna)), abs(dmat_unnormed$rna[ii_proGTrna]), 
       pch = 19, cex = .5, 
       col = crayon[points_cols[1]] )
points(rep(2, sum(ii_proGTrna)), abs(dmat_unnormed$ribo[ii_proGTrna]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[2]] )
points(rep(3, sum(ii_proGTrna)), abs(dmat_unnormed$pro[ii_proGTrna]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[3]] )
text(1.5, 9, adj = 0,
     label = paste("Protein > RNA", sum(ii_proGTrna), "genes" ) )
text(1.5, 8, adj = 0,
     label = paste("RNA vs. Ribo sig. diff.", 
       sum(ii_proGTrna*(res.riborna$int.qval<.01)), "genes; \n",
       round(100*sum(ii_proGTrna*(res.riborna$int.qval<.01))/sum(ii_proGTrna),2),
       "%") ) 
text(1.5, 7, adj = 0,
     label = paste("RNA vs. Ribo sig. diff. & same direction", 
      sum(ii_sam), "genes; \n",
      round(100*sum(ii_sam)/sum(ii_proGTrna),
            2),"%") )
text(1.5, 6, adj = 0,
     label = paste("Reinfored at translation", 
      sum(ii_proGTrna*ii_reinforced_translation), "genes; \n",
      round(100*sum(ii_proGTrna*ii_reinforced_translation)/sum(ii_proGTrna),
            2),"%") )
title(main = paste("RNA < Protein",sum(ii_proGTrna),
                  "genes (Enhanced protein divergence)"),
      ylab = "absolute divergence (human-chimpanzee fold change)")



binom.test(sum(ii_proGTrna*ii_reinforced_translation), 
           sum(ii_proGTrna), p = .0313)
```




### RNA ~ Protein


> Among 2,877 genes that are neither enhanced nor attenuated at the protein level compared to the RNA level (RNA ~ Protein), 375 genes are significantly different in divergence between RNA and Ribo. We computed the number of genes that are enhanced or attenuated at the translation level among these 375 genes.  
> 1. Attenuated translation: (sig. difference between RNA and Ribo) AND ( abs(RNA divergence) > abs(Ribo divergence) OR Ribo divergence is in the opposite direction of RNA divergence)
> 2. Reinforced translation: (sig. difference between RNA and Ribo) AND (abs(RNA divergence) < abs(Ribo divergence) AND Ribo divergence is in the same direction as RNA divergence)


```{r}
ii_enhanced_set <- (dmat_unnormed$rna * dmat_unnormed$ribo > 0) & ( abs(dmat_unnormed$ribo) > abs(dmat_unnormed$rna) )
ii_attenuated_set <- (dmat_unnormed$rna * dmat_unnormed$ribo < 0) | ( abs(dmat_unnormed$ribo) < abs(dmat_unnormed$rna) )


## RNA ~ Protein 
index_list <- list(ii_proNULLrna, ii_rnaGTpro, ii_proGTrna)
boxplot(abs(dmat_unnormed$rna[ii_proNULLrna]),
        abs(dmat_unnormed$ribo[ii_proNULLrna]),
        abs(dmat_unnormed$pro[ii_proNULLrna]), 
        axes = F, ylim = c(0, 10))
axis(1, at = c(1,2,3), labels = c("RNA", "Ribo", "Protein"), 
     col = "white")
axis(2)
points_cols <- c("Scarlet", "Sunglow", "Shamrock")
points(rep(1, sum(ii_proNULLrna)), abs(dmat_unnormed$rna[ii_proNULLrna]), 
       pch = 19, cex = .5, 
       col = crayon[points_cols[1]] )
points(rep(2, sum(ii_proNULLrna)), abs(dmat_unnormed$ribo[ii_proNULLrna]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[2]] )
points(rep(3, sum(ii_proNULLrna)), abs(dmat_unnormed$pro[ii_proNULLrna]), 
       pch = 19, cex = .5,
       col = crayon[points_cols[3]] )
text(2.5, 10, adj = 0,
     label = paste("RNA ~ Protein", sum(ii_proNULLrna), "genes" ) )
text(2.5, 9, adj = 0,
     label = paste("RNA vs. Ribo sig. diff.", 
       sum(ii_proNULLrna*(res.riborna$int.qval<.01)), "genes; \n",
       round(100*sum(ii_proNULLrna*(res.riborna$int.qval<.01))/sum(ii_proNULLrna), 2),
         "%") )
text(2.5, 8, adj = 0,
     label = paste("Attenuated translation", 
       sum(ii_proNULLrna*(res.riborna$int.qval<.01)*ii_attenuated_set),
       "genes; \n",
       round(100*sum(ii_proNULLrna*(res.riborna$int.qval<.01)*ii_attenuated_set)/sum(ii_proNULLrna), 2),
         "%") )
text(2.5, 7, adj = 0,
     label = paste("Enhanced translation", 
       sum(ii_proNULLrna*(res.riborna$int.qval<.01)*ii_enhanced_set),
       "genes; \n",
       round(100*sum(ii_proNULLrna*(res.riborna$int.qval<.01)*ii_enhanced_set)/sum(ii_proNULLrna), 2),
         "%") )
title(main = "RNA ~ Protein, no sig. diff. divergence",
      ylab = "absolute divergence (human-chimpanzee fold change)")

# Compute pairwise p-values between effect sizes of Ribo, RNA, and protein
# among genes with RNA ~ Protein
rna_ribo_t <- t.test( abs(dmat_unnormed$rna[ii_proNULLrna]),
       abs(dmat_unnormed$ribo[ii_proNULLrna]), paired = TRUE )
rna_pro_t <- t.test( abs(dmat_unnormed$rna[ii_proNULLrna]),
       abs(dmat_unnormed$pro[ii_proNULLrna]), paired = TRUE )
ribo_pro_t <- t.test( abs(dmat_unnormed$ribo[ii_proNULLrna]),
       abs(dmat_unnormed$pro[ii_proNULLrna]), paired = TRUE )

text(.5, 10, adj = 0,
     label = paste("Paired t-test of effect sizes") )
text(.5, 9, adj = 0,
     label = paste("RNA vs. Ribo: p-value < 1e-14") )
text(.5, 8, adj = 0,
     label = paste("RNA vs. Protein: p-value < 1e-15") )
text(.5, 7, adj = 0,
     label = paste("Ribo vs. Protein: p-value < 1e-15") )


```



***********************************************************

## Part II

> Among the 375 genes with RNA and Ribo significant differences and no significant difference between RNA and protein, we do a follow-up analysis to look further to consider the contribution/relation of translation divergence to protein divergence, relative to RNA divergence. 


> Yoav: So, for example, if gene 1 (among the 375 genes with sig. diff. between RNA and Ribo) shows attenuated translation relative to RNA, protein divergence will be attenuated relative to RNA divergence. If gene 2 (among the 375 genes with sig. diff. between RNA and Ribo) shows enhanced ribo divergence compared with RNA, I predict that the protein divergence will also be enhanced compared with RNA.


```{r}
ii_select <- ii_proNULLrna*(res.riborna$int.qval<.01)

sub_data <- dmat_unnormed[which(ii_select==1), ]

## Direction of ribo divergence compared to RNA
ii_rna_ribo_enhanced <- (sub_data$rna * sub_data$ribo > 0) & ( abs(sub_data$ribo) > abs(sub_data$rna) )
ii_rna_ribo_attenuated <- (sub_data$rna * sub_data$ribo < 0) | ( abs(sub_data$ribo) < abs(sub_data$rna) )

## Direction of protein divergence compared to RNA
# ii_rna_pro_enhanced <- abs(sub_data$rna) < abs(sub_data$pro)
# ii_rna_pro_attenuated <- abs(sub_data$rna) > abs(sub_data$pro)
ii_rna_pro_enhanced <- (sub_data$rna * sub_data$pro > 0) & ( abs(sub_data$pro) > abs(sub_data$rna) )
ii_rna_pro_attenuated <- (sub_data$rna * sub_data$pro < 0) | ( abs(sub_data$pro) < abs(sub_data$rna) )

plot_mat <- matrix(0, 2, 2)
rownames(plot_mat) <- c("Enhanced at translation relative to RNA (RNA-Ribo enhanced)", "Attenuated at translation relative to RNA (RNA-Ribo attenuated)")
colnames(plot_mat) <- c("Enhanced at protein relative to RNA (RNA-Protein enhanced)", "Attenuated at protein relative to RNA (RNA-Protein attenuated)")

plot_mat[1,1] <- sum(ii_rna_ribo_enhanced*ii_rna_pro_enhanced)
plot_mat[1,2] <- sum(ii_rna_ribo_enhanced*ii_rna_pro_attenuated)
plot_mat[2,1] <- sum(ii_rna_ribo_attenuated*ii_rna_pro_enhanced)
plot_mat[2,2] <- sum(ii_rna_ribo_attenuated*ii_rna_pro_attenuated)

kable(plot_mat)
```


### RNA < Protein

>  Among the 90 genes that were reinforced at translation, we tested the null hypothesis that these genes are as likely to be enhanced as to be attenuated at the protein layer. If this null hypothesis were rejected and the number of genes that were enhanced at the protein layer is more than those attenuated at the protein layer, then we say that genes that are enhanced at the translation level are more likely to be enhanced at the protein level than to be attenuated at the protein level.

> *Results*: NO (p-value = .4608)! Genes that are enhanced at the translation level (relative to RNA) are no more likely to be enhanced at the protein level than to be attenuated at the protein level. 46% of the genes that are enhanced at the translation level are also enhanced at the protein level, relative to the transcript level of species divergence.

```{r}
binom.test(plot_mat[1,1], rowSums(plot_mat)[1])
```


### RNA > Protein

>  Among the 285 genes that were attenuated at the translation level relative to the transcript level (RNA-Ribo attenuation), we tested the null hypothesis that these genes are as likely to be attenuated as to be enhanced at the protein level relative to the transcript level (RNA-Protein). If this null hypothesis were rejected and the number of genes that were attenuated at the protein layer is larger than the number of genes that were enhanced at the protein layer, then we say that attenuation at the translation level is more likey to co-occur with attenuation at the protein level than with enhancement at the protein level.

> *Results*: YES (p-value < 1e-15)! Genes that were attenuated at the translation level are more likely to be attenuated at the protein level than to be enhanced at the protein level. 93% of the genes with attenuated translation relative to the transcript level are also attenuated at the protein level (relative to the transcript level).

```{r}
binom.test(plot_mat[2,2], rowSums(plot_mat)[2])
```




