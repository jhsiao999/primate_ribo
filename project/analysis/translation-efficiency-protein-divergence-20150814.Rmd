---
output:
  knitrBootstrap::bootstrap_document:
    title: "Translation efficiency and protein divergence"
    theme: default
---


Translation efficiency and protein divergence
=============================================

```{r run_author, results='asis', echo=FALSE}
email <- "<a href='mailto:joyce.hsiao1@gmail.com'>Joyce Hsiao</a>"
cat(paste("Author:", email))
```


```{r run_date, results='asis', echo=FALSE}
#last_update = format(Sys.time(), "(<time>%Y-%m-%d</time>)")
last_update <- Sys.time()
cat(paste("Last updated:", last_update))
```


```{r knitr_settings, include=FALSE, echo=FALSE}
library(knitr)
opts_knit$set(progress = TRUE, verbose = TRUE)
opts_chunk$set(message = FALSE, warning = FALSE, eval = TRUE, echo = TRUE,
              bootstrap.panel = FALSE, bootstrap.show.code = FALSE)
#fig.width = 800/96, fig.height = 800/96, dpi = 96,
```




```{r load_packages}
library(Biobase)

## Set working directories 
dir <- "../"
figdir <- file.path(dir,"figures")
rdadir <- file.path(dir,"rdas")
datadir <- file.path(dir, "data")

## Use broman package for colors
require(broman)
crayon <- brocolors("crayons")

## Load customized packages
require(devtools)
require(Humanzee)
```


Human vs. Chimpanzee
====================


```{r, bootstrap.show.code = TRUE}
## load LRT results of RNA vs. Protein divergence
load(file.path(rdadir,"rnapro.rda"))

## load LRT results of Ribo vs. RNA divergence
load(file.path(rdadir,"TEnew.rda"))

## load LRT results of DE analysis
load(file.path(rdadir,"DE.rda"))

## Compute fold changes based on un-normalized data
## from the object eSetRRP.log2 in eSetRRP.rda
load(file.path(rdadir,"eSetRRP.rda"))
eSet.temp = eSetRRP.log2[ ,eSetRRP.log2$species!="rhesus"]
fc.mat=lapply(seq_along(c("human","chimp")), function(i) {
  ii = eSet.temp$species==c("human","chimp")[i]
  eSet.tt = eSet.temp[,ii]
  emat = lapply(seq_along(c("ribo","rna","protein")),function(j) {
    jj = eSet.tt$seqData==c("ribo","rna","protein")[j]
    rowMeans(exprs(eSet.tt[,jj]),na.rm=TRUE)
  })
  emat=do.call(cbind,emat)
  colnames(emat)=c("ribo","rna","protein")
  return(data.frame(emat))
})
names(fc.mat)=c("human","chimp")
dmat_unnormed = data.frame(ribo=fc.mat$human$ribo-fc.mat$chimp$ribo,
                           rna=fc.mat$human$rna-fc.mat$chimp$rna,
                           pro=fc.mat$human$protein-fc.mat$chimp$protein)

xy.rnapro = data.frame(rna=dmat_unnormed$rna,
                       pro=dmat_unnormed$pro)
xy.riborna = data.frame(rna=dmat_unnormed$rna,
                        ribo=dmat_unnormed$ribo)
xy.ribopro = data.frame(ribo=dmat_unnormed$ribo,
                        pro=dmat_unnormed$pro)
```


## RNA-Ribo

Only include genes that are sig. different between species in 
translation efficiency

```{r}
ii_sig_TE <- res.riborna$int.qval < .01
```

ii_sig_RNA_DE <- rnaRes.Q$qval < .01
ii_sig_Ribo_DE <- riboRes.Q$qval < .01
```

# sig. translation efficiency,
# no sig. DE at RNA level & no sig. DE at Ribo level
ii_TE_1 <- ii_sig_TE & !ii_sig_RNA_DE & !ii_sig_Ribo_DE
sum(ii_TE_1)

# sig. translation efficiency, 
# no sig. DE at RNA level but sig. DE at Ribo level
ii_TE_2 <- (ii_sig_TE) & !ii_sig_RNA_DE & ii_sig_Ribo_DE
sum(ii_TE_2)

# sig. translation efficiency, 
# sig. DE at RNA level
# Enhanced divergence
ii_riboGTrna <- 
  (ii_sig_TE) & ii_sig_RNA_DE & 
        ( (abs(xy.riborna$ribo) > abs(xy.riborna$rna)) & 
        (xy.riborna$rna * xy.riborna$ribo > 0 ) )
sum(ii_riboGTrna)

# sig. translation efficiency, 
# no sig. DE at RNA level but sig. DE at Ribo level
# Attenuated divergence
ii_rnaGTribo <- 
  (ii_sig_TE) & ii_sig_RNA_DE & 
        ( (abs(xy.riborna$rna) > abs(xy.riborna$ribo) ) | 
        (xy.riborna$rna * xy.riborna$ribo < 0) ) 
sum(ii_rnaGTribo)



## RNA-Protein

# Attenuated divergence
ii_rnaGTpro <- 
  (res.rnapro$int.qval < .01) & ii_sig_RNA_DE & 
    ( (abs(xy.rnapro$rna) > abs(xy.rnapro$pro) ) | 
    (xy.rnapro$rna * xy.rnapro$pro < 0) ) 

# Enhanced divegence
ii_proGTrna <- 
  (res.rnapro$int.qval < .01) & ii_sig_RNA_DE & 
        ( (abs(xy.rnapro$pro) > abs(xy.rnapro$rna)) & 
        (xy.rnapro$rna * xy.rnapro$rna > 0 ) )


# Prop. of RNA-protein attenuated genes among RNA-Ribo attenuated genes
sum(ii_rnaGTpro & ii_rnaGTribo)/sum(ii_rnaGTribo)


# Prop. of RNA-protein enhanced genes among RNA-Ribo enhanced genes
sum(ii_proGTrna & ii_riboGTrna)/sum(ii_riboGTrna)
```



## Tests


McNemar's chi-squared test to compare the proportion of genes with 
attenuated translation versus enhanced translation (relative to RNA level)


```{r}
mat_riborna <- matrix(0, 2, 2,
                      dimnames = list(attenuation = c("yes", "no"),
                                      enhancement = c("yes", "no") ) )
mat_riborna[1,1] <- sum( (ii_riboGTrna) & (ii_rnaGTribo) )
mat_riborna[2,2] <- sum( !(ii_riboGTrna) & !(ii_rnaGTribo) )
mat_riborna[1,2] <- sum( (ii_riboGTrna) & !(ii_rnaGTribo) )
mat_riborna[2,1] <-  sum( !(ii_riboGTrna) & (ii_rnaGTribo) )

mcnemar.test(mat_riborna)
```


Two-proportion z-test.


```{r}
PropTest(57/119, 1/22, N1 = 119, N = 22)

## Make a data matrix for Fisher's exact test input
mat_fish <- 
  matrix(0, 2, 2, 
  dimnames = list( rna_ribo = c("Attenuation", "Enhancement"),                              rna_pro = c("Attenuation", "Enhancement") ) )
mat_fish[1,1] <- sum(ii_rnaGTribo & ii_rnaGTpro)
mat_fish[2,2] <- sum(ii_riboGTrna & ii_proGTrna)
mat_fish[1,2] <- sum(ii_rnaGTribo & ii_proGTrna)
mat_fish[2,1] <- sum(ii_riboGTrna & ii_rnaGTpro)

## Two-proportion z-test
PropTest(57/119, 1/22, N1 = 119, N = 22)
```


