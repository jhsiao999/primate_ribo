---
title: "CV_SD_mean_each_data_type"
author: "Sidney Wang"
date: "October 8, 2015"
output: html_document
---

load libraries 

```{r}
library("reshape2", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
library("ggplot2", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")
library("dplyr", lib.loc="/Library/Frameworks/R.framework/Versions/3.2/Resources/library")

```


load data and extract data from eSet

```{r}
library("Biobase")
load("/Users/siddisis/Dropbox/work/Ribosome_profiling/Primate_comparison/manuscript/data/rdas/eSetRRP.rda")

rhesus.log2ribo<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "rhesus" & eSetRRP.RP.Q.log2$seqData == "ribo"])
rhesus.log2rna<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "rhesus" & eSetRRP.RP.Q.log2$seqData == "rna"])

chimp.log2ribo<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "chimp" & eSetRRP.RP.Q.log2$seqData == "ribo"])
chimp.log2rna<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "chimp" & eSetRRP.RP.Q.log2$seqData == "rna"])

human.log2ribo<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "human" & eSetRRP.RP.Q.log2$seqData == "ribo"])              
human.log2rna<-exprs(eSetRRP.RP.Q.log2[,eSetRRP.RP.Q.log2$species == "human" & eSetRRP.RP.Q.log2$seqData == "rna"])                      
                      
rhesus.log2TE <- rhesus.log2ribo-rhesus.log2rna

chimp.log2TE <- chimp.log2ribo-chimp.log2rna

human.log2TE <- human.log2ribo-human.log2rna 


```


compute SD, mean and CV for each data type  

ribo
```{r}
SD.ribo.H<-apply(human.log2ribo, 1,sd,na.rm = T)
mean.ribo.H<-apply(human.log2ribo, 1,mean,na.rm = T)
SD.ribo.R<-apply(rhesus.log2ribo, 1,sd,na.rm = T)
mean.ribo.R<-apply(rhesus.log2ribo, 1,mean,na.rm = T)
SD.ribo.C<-apply(chimp.log2ribo, 1,sd,na.rm = T)
mean.ribo.C<-apply(chimp.log2ribo, 1,mean,na.rm = T)

CV.ribo.H <- SD.ribo.H - mean.ribo.H
CV.ribo.R <- SD.ribo.R - mean.ribo.R
CV.ribo.C <- SD.ribo.C - mean.ribo.C

```

rna
```{r}
SD.rna.H<-apply(human.log2rna, 1,sd,na.rm = T)
mean.rna.H<-apply(human.log2rna, 1,mean,na.rm = T)
SD.rna.R<-apply(rhesus.log2rna, 1,sd,na.rm = T)
mean.rna.R<-apply(rhesus.log2rna, 1,mean,na.rm = T)
SD.rna.C<-apply(chimp.log2rna, 1,sd,na.rm = T)
mean.rna.C<-apply(chimp.log2rna, 1,mean,na.rm = T)

CV.rna.H <- SD.rna.H - mean.rna.H
CV.rna.R <- SD.rna.R - mean.rna.R
CV.rna.C <- SD.rna.C - mean.rna.C
```

TE
```{r}
SD.TE.H<-apply(human.log2TE, 1,sd,na.rm = T)
mean.TE.H<-apply(human.log2TE, 1,mean,na.rm = T)
SD.TE.R<-apply(rhesus.log2TE, 1,sd,na.rm = T)
mean.TE.R<-apply(rhesus.log2TE, 1,mean,na.rm = T)
SD.TE.C<-apply(chimp.log2TE, 1,sd,na.rm = T)
mean.TE.C<-apply(chimp.log2TE, 1,mean,na.rm = T)

CV.TE.H <- SD.TE.H - mean.TE.H
CV.TE.R <- SD.TE.R - mean.TE.R
CV.TE.C <- SD.TE.C - mean.TE.C
```

plot sd across data type

```{r, echo=FALSE}



SD.HCR <- melt(as.data.frame(cbind(SD.rna.H,SD.rna.R,SD.rna.C,SD.ribo.H,SD.ribo.R,SD.ribo.C)))
#boxplot(as.data.frame(cbind(SD.rna.H,SD.rna.R,SD.rna.C,SD.ribo.H,SD.ribo.R,SD.ribo.C)), outline=F)

SD.HCR %>% filter(grepl(variable,pattern = "rna")) %>% ggplot(aes(x=value)) + geom_density(aes(fill=variable), alpha=0.3) +labs(title="RNA sd by species", x = "sd")+scale_fill_discrete(name="species",labels =c("Human","Rhesus","Chimp"))


SD.HCR %>% filter(grepl(variable,pattern = "ribo")) %>% ggplot(aes(x=value)) + geom_density(aes(fill=variable), alpha=0.3)+labs(title="ribo sd by species", x = "sd")+scale_fill_discrete(name="species",labels =c("Human","Rhesus","Chimp"))


#SD.HCR %>% ggplot(aes(y=value, x=variable)) + geom_boxplot(aes(group=variable, fill=variable), notch=TRUE)

SD.HCR %>% filter(grepl(variable,pattern = "rna")) %>% ggplot(aes(y=value, x=variable)) + geom_boxplot(aes(fill=variable),notch=TRUE)+scale_fill_discrete(guide_legend(title="species"), labels =c("Human","Rhesus","Chimp"))+labs(title="RNA sd by species", y = "sd", x="species")

SD.HCR %>% filter(grepl(variable,pattern = "ribo")) %>% ggplot(aes(y=value, x=variable)) + geom_boxplot(aes(fill=variable),notch=TRUE)+scale_fill_discrete(guide_legend(title="species"), labels =c("Human","Rhesus","Chimp"))+labs(title="ribo sd by species", y = "sd", x="species")



```



plot sd by expression level and effect size

```{r}

SD.HCR.RNA <- melt(as.data.frame(cbind(SD.rna.H,SD.rna.R,SD.rna.C)))
SD.HCR.ribo <- melt(as.data.frame(cbind(SD.ribo.H,SD.ribo.R,SD.ribo.C)))

HC.fold.change.ribo <-  mean.ribo.H - mean.ribo.C
HC.fold.change.rna <- mean.rna.H - mean.rna.C

mean.level.ribo <- cbind(mean.ribo.H,mean.ribo.R,mean.ribo.C)
mean.level.rna <- cbind(mean.rna.H,mean.rna.R,mean.rna.C)


HCR.ribo.expr.cat<-cut(apply(mean.level.ribo, 1, mean),breaks = 10)
HC.ribo.effect.cat<-cut(abs(HC.fold.change.ribo),breaks = 10)
HC.ribo.effect.cat<-cut(abs(HC.fold.change.ribo),breaks = c(0,0.002,0.005,0.01,0.02,0.03,0.05,0.1,0.15,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1,2,4,10))
#SD.HCR.ribo<-as.data.frame(cbind(SD.HCR.ribo,as.numeric(HC.ribo.effect.cat)))
SD.HCR.ribo<-as.data.frame(cbind(SD.HCR.ribo,HC.ribo.effect.cat,HCR.ribo.expr.cat))
names(SD.HCR.ribo)[3:4] <-c("eff.cat","expr.cat")

SD.HCR.ribo %>% ggplot(aes(y=value, x=variable)) + geom_boxplot(aes(group=variable, colour=variable, fill=variable)) + facet_wrap(~ eff.cat)

SD.HCR.ribo %>% ggplot(aes(y=value, x=variable)) + geom_boxplot(aes(group=variable, colour=variable, fill=variable)) + facet_wrap(~ expr.cat)









```